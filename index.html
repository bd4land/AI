<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD4land Master AI | Hybrid V3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&family=Inter:wght@300;400;600&display=swap');
        
        :root {
            --bg-color: #f9fafb;
            --sidebar-bg: #f3f4f6;
            --ai-bubble: #ffffff;
            --accent: #2563eb;
        }

        body { font-family: 'Hind Siliguri', 'Inter', sans-serif; background-color: var(--bg-color); overflow: hidden; }
        
        .chat-container { height: calc(100vh - 160px); }
        
        /* Sidebar Glassmorphism */
        .sidebar {
            transition: all 0.3s ease;
            width: 260px;
        }

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -260px; z-index: 50; height: 100%; }
            .sidebar.active { left: 0; }
        }

        /* Message Bubbles */
        .ai-msg { border-radius: 2px 16px 16px 16px; border: 1px solid #e5e7eb; background: white; }
        .user-msg { border-radius: 16px 16px 2px 16px; background: var(--accent); color: white; }

        /* Cursor Animation */
        .cursor { display: inline-block; width: 3px; height: 15px; background: #2563eb; margin-left: 2px; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        /* Code Block Design */
        .code-header { background: #1e293b; color: #cbd5e1; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        pre[class*="language-"] { margin-top: 0 !important; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    </style>
</head>
<body class="flex text-gray-900">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gray-100 border-r flex flex-col h-screen shadow-inner">
        <div class="p-4">
            <button onclick="resetChat()" class="w-full border-2 border-dashed border-gray-300 rounded-lg py-2 text-sm font-semibold text-gray-600 hover:bg-white hover:border-blue-400 transition shadow-sm">
                <i class="fas fa-plus mr-2"></i> New Chat
            </button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto px-4 space-y-2"></div>
        <div class="p-4 border-t text-xs text-gray-400 font-bold uppercase tracking-widest text-center">
            BD4land Master V3
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen relative">
        <!-- Top Nav -->
        <header class="h-14 border-b bg-white/80 backdrop-blur-md flex items-center justify-between px-4 sticky top-0 z-40">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500"><i class="fas fa-bars"></i></button>
                <span class="font-bold text-blue-600 flex items-center gap-2">
                    <i class="fas fa-brain"></i> BD4land Master AI
                </span>
            </div>
            <div class="flex gap-4 text-gray-400 text-sm font-medium">
                <span class="flex items-center gap-1"><i class="fas fa-microchip text-xs"></i> DeepThink</span>
                <span class="flex items-center gap-1"><i class="fas fa-globe text-xs"></i> Web Search</span>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-box" class="chat-container overflow-y-auto p-4 md:px-20 space-y-6">
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white flex-shrink-0"><i class="fas fa-robot text-xs"></i></div>
                <div class="ai-msg p-4 shadow-sm max-w-3xl">
                    আসসালামু আলাইকুম! আমি **BD4land Master**। আমি DeepSeek এবং ChatGPT-এর হাইব্রিড ভার্সন। আজ কী সাহায্য করতে পারি?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:px-20 bg-gradient-to-t from-gray-50 to-transparent">
            <div id="status-chips" class="flex gap-2 mb-2"></div>
            
            <div class="max-w-4xl mx-auto relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition duration-300"></div>
                <div class="relative flex items-end gap-2 bg-white rounded-2xl p-2 border border-gray-200 shadow-xl">
                    <textarea id="input" rows="1" placeholder="প্রোগ্রামিং সলভ বা ছবি আঁকতে বলুন..." 
                        class="w-full bg-transparent px-4 py-3 focus:outline-none resize-none max-h-48 text-gray-700"></textarea>
                    
                    <button onclick="send()" id="send-btn" 
                        class="bg-blue-600 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-blue-700 transition-all disabled:opacity-50 shadow-md">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-center mt-3 text-gray-400 font-medium tracking-tight">DeepSeek R1 + GPT-4o Hybrid Architecture</p>
        </div>
    </main>

<script>
    let chatHistory = [];
    const box = document.getElementById('chat-box');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const statusChips = document.getElementById('status-chips');

    // Marked.js Configuration (Fixed [object Object] issue)
    const renderer = new marked.Renderer();
    renderer.code = function(token) {
        const code = token.text || "";
        const lang = token.lang || "text";
        const id = 'code-' + Math.random().toString(36).substr(2, 5);
        
        return `<div class="my-4 overflow-hidden rounded-lg shadow-lg border border-gray-700">
                    <div class="code-header px-4 py-2 text-xs flex justify-between items-center font-mono">
                        <span class="uppercase"><i class="fas fa-code mr-1"></i> ${lang}</span>
                        <button onclick="copyCode('${id}')" class="hover:text-blue-400 transition flex items-center gap-1">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre id="${id}" class="language-${lang}"><code class="language-${lang}">${escapeHtml(code)}</code></pre>
                </div>`;
    };
    marked.setOptions({ renderer: renderer, breaks: true });

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    function addStatusChip(text, icon) {
        const chip = document.createElement('div');
        chip.className = "bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2 animate-pulse mb-2";
        chip.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        statusChips.appendChild(chip);
        setTimeout(() => chip.remove(), 6000);
        return chip;
    }

    async function send() {
        const prompt = input.value.trim();
        if(!prompt) return;

        appendMessage(prompt, 'user');
        input.value = '';
        input.style.height = 'auto';
        sendBtn.disabled = true;
        statusChips.innerHTML = '';

        const aiWrapper = appendMessage("", 'ai');
        const contentArea = aiWrapper.querySelector('.content-area');
        let fullText = "";

        try {
            const response = await fetch('https://ai.bd4search.workers.dev', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt, history: chatHistory })
            });

            if (!response.ok) throw new Error("সার্ভার রেসপন্স করছে না");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = ""; 

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop(); 

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine.startsWith('data: ')) continue;

                    try {
                        const jsonStr = trimmedLine.substring(6);
                        const data = JSON.parse(jsonStr);

                        if (data.type === 'status') {
                            addStatusChip(data.content, 'fa-spinner fa-spin');
                        } else if (data.type === 'text') {
                            fullText += data.content;
                            contentArea.innerHTML = marked.parse(fullText) + '<span class="cursor"></span>';
                            if (fullText.length % 15 === 0) Prism.highlightAllUnder(aiWrapper);
                        } else if (data.type === 'image') {
                            renderImage(aiWrapper, data.content);
                        } else if (data.type === 'error') {
                            throw new Error(data.content);
                        }
                    } catch (e) { console.warn("Parse Error"); }
                }
                box.scrollTop = box.scrollHeight;
            }
            
            contentArea.querySelector('.cursor')?.remove();
            Prism.highlightAllUnder(aiWrapper);
            chatHistory.push({role: 'user', content: prompt}, {role: 'assistant', content: fullText});
            updateHistoryUI(prompt);

        } catch(e) {
            contentArea.innerHTML = `<p class="text-red-500 font-bold"><i class="fas fa-exclamation-circle"></i> দুঃখিত: ${e.message}</p>`;
        } finally {
            sendBtn.disabled = false;
        }
    }

    function appendMessage(content, role) {
        const div = document.createElement('div');
        div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : ''}`;
        div.innerHTML = `
            ${role === 'ai' ? '<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white flex-shrink-0 shadow-md"><i class="fas fa-robot text-xs"></i></div>' : ''}
            <div class="${role === 'user' ? 'user-msg shadow-md' : 'ai-msg shadow-sm'} p-4 max-w-[85%] md:max-w-3xl overflow-hidden">
                <div class="content-area prose prose-sm max-w-none">
                    ${role === 'user' ? escapeHtml(content) : (content ? marked.parse(content) : '<span class="animate-pulse">Thinking...</span>')}
                </div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div;
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function renderImage(container, url) {
        container.querySelector('.content-area').innerHTML = `
            <div class="mt-2 group relative border rounded-xl overflow-hidden shadow-lg border-blue-200">
                <img src="${url}" class="w-full h-auto object-cover max-w-md">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                    <a href="${url}" target="_blank" class="bg-white text-black px-4 py-2 rounded-lg text-xs font-bold shadow-xl flex items-center gap-1"><i class="fas fa-expand"></i> Full View</a>
                </div>
            </div>`;
    }

    function updateHistoryUI(text) {
        const list = document.getElementById('history-list');
        const item = document.createElement('div');
        item.className = "p-3 text-sm text-gray-600 truncate hover:bg-white rounded-lg cursor-pointer border-l-4 border-transparent hover:border-blue-500 transition-all bg-gray-50/50 mb-1";
        item.innerHTML = `<i class="far fa-comment-alt mr-2 text-blue-400"></i> ${text}`;
        list.prepend(item);
    }

    function copyCode(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector(`[onclick="copyCode('${id}')"]`);
            btn.innerHTML = '<i class="fas fa-check"></i> Copied';
            setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i> Copy', 2000);
        });
    }

    function resetChat() {
        if(confirm("সব কনভার্সেশন মুছে ফেলবেন?")) {
            chatHistory = [];
            box.innerHTML = '';
            location.reload();
        }
    }

    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });
</script>
</body>
</html>
