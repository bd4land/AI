<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD4LAND AI | Pro 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&display=swap');
        :root { --bd-green: #006a4e; --bd-red: #f42a41; }
        body { font-family: 'Hind Siliguri', sans-serif; background: #f8fafc; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e5e7eb; transition: 0.3s; z-index: 50; }
        @media (max-width: 768px) { .sidebar { position: absolute; left: -280px; height: 100%; } .sidebar.active { left: 0; } }
        .ai-bubble { background: #fff; border: 1px solid #e2e8f0; border-radius: 2px 18px 18px 18px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .user-bubble { background: var(--bd-green); color: #fff; border-radius: 18px 18px 2px 18px; box-shadow: 0 4px 6px rgba(0, 106, 78, 0.1); }
        .active-chat { background: #f0fdf4; border-left: 4px solid var(--bd-green); font-weight: bold; color: var(--bd-green); }
        .cursor { display: inline-block; width: 2px; height: 16px; background: var(--bd-green); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        /* ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .dot-flashing { position: relative; width: 10px; height: 10px; border-radius: 5px; background-color: var(--bd-green); color: var(--bd-green); animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -15px; width: 10px; height: 10px; border-radius: 5px; background-color: var(--bd-green); color: var(--bd-green); animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 15px; width: 10px; height: 10px; border-radius: 5px; background-color: var(--bd-green); color: var(--bd-green); animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: var(--bd-green); } 50%, 100% { background-color: #ebe6ff; } }
    </style>
</head>
<body class="flex h-screen text-gray-900">

<!-- Sidebar -->
<aside id="sidebar" class="sidebar flex flex-col shadow-2xl">
    <div class="p-4 border-b bg-gray-50">
        <button onclick="newChat()" class="w-full bg-white border border-gray-300 rounded-xl py-2.5 font-bold text-gray-700 hover:border-green-600 hover:text-green-600 transition flex items-center justify-center gap-2 shadow-sm">
            <i class="fa fa-plus text-xs"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    <div class="p-4 border-t text-[10px] font-bold text-gray-400 uppercase tracking-widest text-center">
        BD4LAND MASTER V3.5 ‚Ä¢ 2025
    </div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col relative bg-[#f9fafb]">
    <header class="h-14 bg-white/80 backdrop-blur-md border-b flex items-center justify-between px-6 shadow-sm sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <button onclick="document.getElementById('sidebar').classList.toggle('active')" class="md:hidden text-gray-500 p-2 hover:bg-gray-100 rounded-lg"><i class="fa fa-bars"></i></button>
            <h2 id="chatTitle" class="font-bold text-gray-700 truncate max-w-[180px] md:max-w-md">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®</h2>
        </div>
        <div class="flex items-center gap-2 text-[10px] font-bold text-green-600 bg-green-50 px-2.5 py-1 rounded-full border border-green-200">
            <i class="fa fa-circle text-[6px] animate-pulse"></i> 2025 LIVE ENGINE
        </div>
    </header>

    <div id="chatBox" class="flex-1 overflow-y-auto p-4 md:px-32 lg:px-64 space-y-6">
        <!-- ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá -->
    </div>

    <!-- Input -->
    <div class="p-4 md:px-32 lg:px-64 bg-white border-t shadow-inner">
        <div id="status" class="flex flex-wrap gap-2 mb-2"></div>
        <div id="imgWrap" class="hidden mb-3 relative inline-block">
            <img id="imgPreview" class="h-24 rounded-lg border-2 border-green-500 shadow-lg">
            <button onclick="clearImg()" class="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-xl hover:bg-red-700">√ó</button>
        </div>
        <div class="max-w-4xl mx-auto flex gap-2 bg-gray-50 rounded-2xl p-2 items-end border border-gray-200 focus-within:bg-white focus-within:border-green-600 transition-all shadow-md">
            <label class="cursor-pointer p-3 text-gray-400 hover:text-green-600 transition">
                <i class="fa fa-camera text-xl"></i>
                <input type="file" id="image-input" hidden accept="image/*" onchange="handleImg(event)">
            </label>
            <textarea id="userInput" rows="1" class="flex-1 bg-transparent p-3 outline-none resize-none max-h-40 text-gray-700 font-medium" placeholder="‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ, ‡¶Ü‡¶ú ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?"></textarea>
            <button id="sendBtn" onclick="handleSend()" class="bg-green-700 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-green-800 transition disabled:opacity-50 shadow-lg">
                <i class="fa fa-paper-plane"></i>
            </button>
        </div>
    </div>
</main>

<script>
const API = "https://ai.obaydul2009-info.workers.dev";
const AUTH = "my_secure_handshake_key";

let chats = JSON.parse(localStorage.getItem("bd_chats_v4") || "{}");
let activeId = localStorage.getItem("active_id_v4");
let selectedImg = null;

function save() { 
    localStorage.setItem("bd_chats_v4", JSON.stringify(chats)); 
    localStorage.setItem("active_id_v4", activeId); 
}

function newChat() {
    activeId = "chat_" + Date.now();
    chats[activeId] = { title: "‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®", msgs: [] };
    save(); render();
}

function switchChat(id) { activeId = id; render(); }

function deleteChat(id) {
    if(confirm("‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶ü‡¶ø ‡¶ï‡¶ø ‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
        delete chats[id];
        activeId = Object.keys(chats)[0] || null;
        if(!activeId) newChat(); else { save(); render(); }
    }
}

function render() {
    const list = document.getElementById("chatList"); list.innerHTML = "";
    Object.keys(chats).reverse().forEach(id => {
        const div = document.createElement("div");
        div.className = `p-3 rounded-xl cursor-pointer flex justify-between items-center group transition ${id === activeId ? 'active-chat shadow-sm' : 'hover:bg-gray-100 text-gray-500'}`;
        div.innerHTML = `<span class="truncate flex-1" onclick="switchChat('${id}')">${chats[id].title}</span>
                         <i class="fa fa-trash-alt text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition" onclick="deleteChat('${id}')"></i>`;
        list.appendChild(div);
    });

    const box = document.getElementById("chatBox"); box.innerHTML = "";
    if(chats[activeId]) {
        chats[activeId].msgs.forEach(m => appendUI(m.role, m.text, m.img));
        document.getElementById("chatTitle").innerText = chats[activeId].title;
    }
    box.scrollTop = box.scrollHeight;
}

function appendUI(role, text, img) {
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    div.innerHTML = `
        <div class="${role === 'user' ? 'user-bubble' : 'ai-bubble'} max-w-[90%] md:max-w-2xl p-4 shadow-sm">
            ${img ? `<img src="data:image/jpeg;base64,${img}" class="mb-3 rounded-lg max-h-64 shadow-md border-2 border-white">` : ""}
            <div class="markdown-body text-sm leading-relaxed text-wrap break-words">${text ? marked.parse(text) : '<div class="flex items-center gap-3 py-2"><div class="dot-flashing"></div><span class="text-xs text-gray-400 font-bold uppercase">Processing</span></div>'}</div>
        </div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    return div.querySelector(".markdown-body");
}

async function handleSend() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if(!text && !selectedImg) return;

    const currentImg = selectedImg;
    chats[activeId].msgs.push({ role: "user", text, img: currentImg });
    if(chats[activeId].title === "‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®" && text) chats[activeId].title = text.substring(0, 30);
    
    render();
    input.value = ""; clearImg();
    document.getElementById("sendBtn").disabled = true;

    const aiPlaceholder = appendUI("assistant", "");
    let fullRes = "";

    try {
        const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Custom-Auth": AUTH },
            body: JSON.stringify({ prompt: text, image: currentImg, history: chats[activeId].msgs.slice(-8) })
        });

        if (!res.ok) {
             if(res.status === 503) throw new Error("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶® ‡¶ò‡ßÅ‡¶Æ‡¶ø‡ßü‡ßá ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶ú‡¶æ‡¶ó‡¶ø‡ßü‡ßá ‡¶§‡ßÅ‡¶≤‡¶õ‡¶ø, ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
             throw new Error(`‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶∞‡¶∞ (HTTP ${res.status})`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split("\n");
            buffer = lines.pop(); 

            for (let line of lines) {
                let trimmed = line.trim();
                if (trimmed.startsWith("data: ")) {
                    try {
                        const data = JSON.parse(trimmed.substring(6));
                        if (data.type === "text") {
                            fullRes += data.content;
                            aiPlaceholder.innerHTML = marked.parse(fullRes) + '<span class="cursor"></span>';
                        }
                        if (data.type === "status") showStatus(data.content);
                        if (data.type === "error") throw new Error(data.content);
                    } catch (e) { console.error("Parse Fail:", e); }
                }
            }
            document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
        }

        aiPlaceholder.innerHTML = marked.parse(fullRes);
        chats[activeId].msgs.push({ role: "assistant", text: fullRes });
        save();
        Prism.highlightAllUnder(aiPlaceholder.parentElement);
    } catch (e) {
        aiPlaceholder.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-xs font-mono"><b>SYSTEM DEBUG:</b><br>${e.message}</div>`;
    } finally {
        document.getElementById("sendBtn").disabled = false;
    }
}

// ‡¶≠‡¶ø‡¶∂‡¶® ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ú‡¶æ‡¶∞
function handleImg(e) {
    const file = e.target.files[0]; if(!file) return;
    showStatus("üì∏ ‡¶õ‡¶¨‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
    const r = new FileReader();
    r.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement("canvas");
            const max_dim = 600; // ‡¶≠‡¶ø‡¶∂‡¶® ‡¶Æ‡¶°‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø‡¶á ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ú
            let w = img.width, h = img.height;
            if (w > h) { if (w > max_dim) { h *= max_dim / w; w = max_dim; } } 
            else { if (h > max_dim) { w *= max_dim / h; h = max_dim; } }
            
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            
            // Quality 0.5 (‡¶ï‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶° - ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶π‡ßç‡¶Ø‡¶æ‡¶Ç ‡¶®‡¶æ ‡¶π‡ßü)
            selectedImg = canvas.toDataURL("image/jpeg", 0.5).split(",")[1];
            document.getElementById("imgPreview").src = canvas.toDataURL("image/jpeg");
            document.getElementById("imgWrap").classList.remove("hidden");
        };
        img.src = ev.target.result;
    };
    r.readAsDataURL(file);
}

function showStatus(t) {
    const s = document.getElementById("status");
    const d = document.createElement("div");
    d.className = "text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded-full border border-green-200 font-bold animate-pulse";
    d.innerHTML = `<i class="fa fa-info-circle mr-1"></i> ${t}`;
    s.appendChild(d);
    setTimeout(() => d.remove(), 5000);
}

function clearImg() { selectedImg = null; document.getElementById("imgWrap").classList.add("hidden"); document.getElementById("image-input").value = ""; }

document.getElementById("userInput").addEventListener("keydown", e => {
    if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
});

if(!activeId || !chats[activeId]) newChat(); else render();
marked.setOptions({ breaks: true, gfm: true });
</script>
</body>
</html>
