<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD4land Master AI | 2025 Stable</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&display=swap');
        :root { --bd-green: #006a4e; --bd-red: #f42a41; }
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .chat-container { height: calc(100vh - 170px); scroll-behavior: smooth; }
        .sidebar { transition: all 0.3s ease; width: 280px; z-index: 50; background: #ffffff; }
        @media (max-width: 768px) { .sidebar { position: absolute; left: -280px; height: 100%; } .sidebar.active { left: 0; } }
        .ai-msg { border-radius: 2px 18px 18px 18px; border: 1px solid #e2e8f0; background: white; }
        .user-msg { border-radius: 18px 18px 2px 18px; background: var(--bd-green); color: white; }
        .conv-item.active { background: #f0fdf4; border-left: 4px solid var(--bd-green); color: var(--bd-green); }
        .cursor { display: inline-block; width: 3px; height: 15px; background: var(--bd-green); margin-left: 2px; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex text-gray-900">

    <aside id="sidebar" class="sidebar border-r flex flex-col h-screen shadow-lg">
        <div class="p-4 bg-gray-50 border-b">
            <button onclick="createNewChat()" class="w-full bg-white border border-gray-300 rounded-xl py-2.5 text-sm font-bold text-gray-700 hover:bg-green-50 hover:border-green-600 transition flex items-center justify-center gap-2">
                <i class="fas fa-plus text-green-600"></i> নতুন চ্যাট শুরু করুন
            </button>
        </div>
        <div id="conv-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        <div class="p-4 border-t bg-gray-50 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white text-[10px] shadow-md"><i class="fas fa-flag"></i></div>
            <div class="text-[11px] font-bold text-green-800 uppercase tracking-tighter">BD4land Master<br><span class="text-gray-400 text-[9px]">2025 HYBRID V3.5</span></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-14 border-b bg-white/90 backdrop-blur flex items-center justify-between px-6 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="current-chat-title" class="font-bold text-gray-700 truncate max-w-[180px] md:max-w-md">নতুন কথোপকথন</h2>
            </div>
            <div class="flex gap-2 text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100">
                <i class="fas fa-circle text-[6px]"></i> 2025 ACTIVE
            </div>
        </header>

        <div id="chat-box" class="chat-container overflow-y-auto p-4 md:px-24 lg:px-48 space-y-6"></div>

        <div class="p-4 md:px-24 lg:px-48 bg-white border-t">
            <div id="status-chips" class="flex gap-2 mb-2"></div>
            <div id="image-preview-container" class="hidden mb-3 p-2 bg-gray-50 rounded-xl border border-dashed border-gray-300 relative inline-block">
                <img id="image-preview" src="" class="h-20 rounded shadow-md border-2 border-white">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-lg hover:bg-red-600 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="relative flex items-end gap-2 bg-gray-50 rounded-2xl p-2 border border-gray-200 focus-within:bg-white focus-within:border-green-600 transition-all shadow-sm">
                <label class="p-3 text-gray-400 hover:text-green-600 cursor-pointer transition">
                    <i class="fas fa-paperclip text-xl"></i>
                    <input type="file" id="image-input" class="hidden" accept="image/*" onchange="processImage(event)">
                </label>
                <textarea id="input" rows="1" placeholder="যেকোনো কিছু জিজ্ঞাসা করুন..." class="w-full bg-transparent px-2 py-3 focus:outline-none resize-none max-h-40 text-gray-700 font-medium"></textarea>
                <button onclick="send()" id="send-btn" class="bg-green-700 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-green-800 disabled:opacity-50 shadow-lg"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

<script>
    let db, currentChatId = localStorage.getItem('currentChatId') || null, chatHistory = [], selectedImageBase64 = null;
    const box = document.getElementById('chat-box'), input = document.getElementById('input'), sendBtn = document.getElementById('send-btn'), statusChips = document.getElementById('status-chips');

    // DB Setup
    const dbRequest = indexedDB.open("BD4land_DB_V25", 1);
    dbRequest.onupgradeneeded = (e) => {
        const d = e.target.result;
        d.createObjectStore("conversations", { keyPath: "id" });
        d.createObjectStore("messages", { keyPath: "msgId", autoIncrement: true }).createIndex("chatId", "chatId", { unique: false });
    };
    dbRequest.onsuccess = (e) => { db = e.target.result; initApp(); };

    async function initApp() {
        renderConversationList();
        if (currentChatId) switchChat(currentChatId); else createNewChat();
    }

    async function createNewChat() {
        const id = "chat_" + Date.now();
        const tx = db.transaction("conversations", "readwrite");
        await tx.objectStore("conversations").add({ id, title: "নতুন কথোপকথন", time: Date.now() });
        switchChat(id);
    }

    function switchChat(id) {
        currentChatId = id;
        localStorage.setItem('currentChatId', id);
        box.innerHTML = ""; chatHistory = [];
        document.getElementById('sidebar').classList.remove('active');
        renderConversationList();

        const tx = db.transaction(["conversations", "messages"], "readonly");
        tx.objectStore("conversations").get(id).onsuccess = (e) => {
            if (e.target.result) document.getElementById('current-chat-title').innerText = e.target.result.title;
        };
        tx.objectStore("messages").index("chatId").getAll(id).onsuccess = (e) => {
            const msgs = e.target.result;
            msgs.forEach(m => {
                const div = appendMessage(m.content, m.role, m.image);
                if (m.role === 'ai') div.querySelector('.content-area').innerHTML = marked.parse(m.content);
            });
            chatHistory = msgs.slice(-10).map(m => ({ role: m.role, content: m.content }));
            Prism.highlightAll();
            box.scrollTop = box.scrollHeight;
        };
    }

    function renderConversationList() {
        const list = document.getElementById('conv-list');
        list.innerHTML = "";
        const tx = db.transaction("conversations", "readonly");
        tx.objectStore("conversations").getAll().onsuccess = (e) => {
            e.target.result.sort((a,b)=>b.time-a.time).forEach(c => {
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 text-sm rounded-xl cursor-pointer border border-transparent hover:bg-white transition ${c.id === currentChatId ? 'active shadow-sm bg-white' : 'text-gray-500'}`;
                div.onclick = () => switchChat(c.id);
                div.innerHTML = `<div class="flex items-center gap-3 truncate"><i class="far fa-message"></i><span class="truncate font-medium">${c.title}</span></div>
                    <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(div);
            });
        };
    }

    async function deleteChat(id) {
        if (!confirm("মুছে ফেলতে চান?")) return;
        const tx = db.transaction(["conversations", "messages"], "readwrite");
        tx.objectStore("conversations").delete(id);
        if (currentChatId === id) { localStorage.removeItem('currentChatId'); currentChatId = null; location.reload(); } else renderConversationList();
    }

    async function send() {
        const prompt = input.value.trim();
        if (!prompt && !selectedImageBase64) return;
        const imgToSend = selectedImageBase64;
        appendMessage(prompt, 'user', imgToSend);
        
        const tx = db.transaction(["messages", "conversations"], "readwrite");
        tx.objectStore("messages").add({ chatId: currentChatId, role: 'user', content: prompt, image: imgToSend });
        
        if (chatHistory.length === 0 && prompt) {
            const store = tx.objectStore("conversations");
            store.get(currentChatId).onsuccess = (e) => {
                const conv = e.target.result;
                if(conv) { conv.title = prompt.substring(0, 25) + "..."; store.put(conv); renderConversationList(); }
            };
        }

        input.value = ''; input.style.height = 'auto'; sendBtn.disabled = true; clearImage();
        const aiWrapper = appendMessage("", 'ai'), contentArea = aiWrapper.querySelector('.content-area');
        let fullText = "";

        try {
            const response = await fetch('https://ai.obaydul2009-info.workers.dev', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, history: chatHistory, image: imgToSend })
            });

            const reader = response.body.getReader(), decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.trim().startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.trim().substring(6));
                            if (data.type === 'text') { fullText += data.content; contentArea.innerHTML = marked.parse(fullText) + '<span class="cursor"></span>'; }
                            else if (data.type === 'status') showStatus(data.content);
                        } catch (e) { }
                    }
                }
                box.scrollTop = box.scrollHeight;
            }
            contentArea.querySelector('.cursor')?.remove();
            Prism.highlightAllUnder(aiWrapper);
            db.transaction("messages", "readwrite").objectStore("messages").add({ chatId: currentChatId, role: 'ai', content: fullText });
            chatHistory.push({ role: 'user', content: prompt }, { role: 'ai', content: fullText });
        } catch (e) { contentArea.innerHTML = "সার্ভারে সমস্যা হয়েছে।"; } finally { sendBtn.disabled = false; }
    }

    function appendMessage(content, role, imageData = null) {
        const div = document.createElement('div'); div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : ''}`;
        let imgTag = imageData ? `<img src="data:image/jpeg;base64,${imageData}" class="max-h-60 rounded-xl mb-2 shadow-md border-2 border-white">` : '';
        div.innerHTML = `${role === 'ai' ? '<div class="w-8 h-8 rounded-full bg-green-700 flex items-center justify-center text-white flex-shrink-0 font-bold shadow-md">B</div>' : ''}
            <div class="${role === 'user' ? 'user-msg' : 'ai-msg'} p-4 max-w-[85%] md:max-w-2xl overflow-hidden shadow-sm">
                ${imgTag}<div class="content-area prose prose-sm max-w-none">${role === 'user' ? escapeHtml(content) : (content ? marked.parse(content) : '<span class="animate-pulse">প্রসেস হচ্ছে...</span>')}</div>
            </div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight; return div;
    }

    function processImage(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas'); const MAX_WIDTH = 800;
                canvas.width = MAX_WIDTH; canvas.height = img.height * (MAX_WIDTH / img.width);
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                document.getElementById('image-preview').src = canvas.toDataURL('image/jpeg');
                document.getElementById('image-preview-container').classList.remove('hidden');
            }; img.src = e.target.result;
        }; reader.readAsDataURL(file);
    }

    function clearImage() { selectedImageBase64 = null; document.getElementById('image-input').value = ""; document.getElementById('image-preview-container').classList.add('hidden'); }
    function showStatus(text) { const chip = document.createElement('div'); chip.className = "bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-200 animate-pulse mb-2"; chip.innerHTML = text; statusChips.appendChild(chip); setTimeout(() => chip.remove(), 4000); }
    function escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text ? text.replace(/[&<>"']/g, m => map[m]) : ''; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function copyCode(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("কপি হয়েছে!"); }
    input.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

    // Marked & Prism Logic
    const renderer = new marked.Renderer();
    renderer.code = (token) => {
        const id = 'code-' + Math.random().toString(36).substr(2, 5);
        return `<div class="my-4 rounded-lg overflow-hidden border border-gray-700 shadow-xl">
            <div class="bg-gray-800 px-4 py-2 text-[10px] text-gray-400 flex justify-between"><span>${token.lang || 'code'}</span><button onclick="copyCode('${id}')" class="hover:text-white"><i class="far fa-copy"></i> Copy</button></div>
            <pre id="${id}" class="language-${token.lang}"><code class="language-${token.lang}">${escapeHtml(token.text)}</code></pre></div>`;
    };
    marked.setOptions({ renderer, breaks: true });
</script>
</body>
</html>
