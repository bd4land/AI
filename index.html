<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BD4LAND Master AI | 2025</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Prism -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&display=swap');
:root{--bd:#006a4e}
body{font-family:'Hind Siliguri',sans-serif;background:#f9fafb}
.ai{background:#fff;border:1px solid #e5e7eb;border-radius:6px 18px 18px 18px}
.user{background:var(--bd);color:#fff;border-radius:18px 18px 6px 18px}
.cursor{display:inline-block;width:3px;height:16px;background:var(--bd);animation:blink 1s infinite}
@keyframes blink{50%{opacity:0}}
</style>
</head>

<body class="flex h-screen text-gray-900">

<!-- SIDEBAR -->
<aside id="sidebar" class="w-72 bg-white border-r flex flex-col">
<div class="p-4 border-b">
<button onclick="newChat()" class="w-full border rounded-xl py-2 font-bold">
<i class="fa fa-plus"></i> নতুন চ্যাট
</button>
</div>
<div id="chatList" class="flex-1 overflow-y-auto p-2"></div>
<div class="p-3 text-xs font-bold text-green-700">BD4LAND AI • 2025</div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col">

<header class="h-14 border-b bg-white flex items-center justify-between px-4">
<h2 id="chatTitle" class="font-bold truncate">নতুন কথোপকথন</h2>
<span class="text-xs bg-green-100 px-2 py-1 rounded">LIVE</span>
</header>

<div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

<!-- INPUT -->
<div class="border-t bg-white p-3">
<div id="status" class="flex gap-2 mb-2"></div>

<div id="imgPreviewWrap" class="hidden mb-2 relative inline-block">
<img id="imgPreview" class="h-16 rounded">
<button onclick="clearImg()" class="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-xs">×</button>
</div>

<div class="flex gap-2 bg-gray-100 rounded-2xl p-2 items-end">
<label class="cursor-pointer p-2">
<i class="fa fa-camera"></i>
<input hidden type="file" accept="image/*" onchange="loadImg(event)">
</label>
<textarea id="input" rows="1" class="flex-1 bg-transparent resize-none outline-none"
placeholder="বাংলাদেশ সম্পর্কিত যেকোনো প্রশ্ন করুন..."></textarea>
<button onclick="send()" class="bg-green-700 text-white w-11 h-11 rounded-xl">
<i class="fa fa-paper-plane"></i>
</button>
</div>
</div>

</main>

<script>
const API="https://ai.obaydul2009-info.workers.dev";
const AUTH="my_secure_handshake_key";

let chats=JSON.parse(localStorage.getItem("bdChats")||"{}");
let current=null;
let imgBase64=null;

const box=q("chatBox"),input=q("input");

function q(id){return document.getElementById(id)}

function newChat(){
current="chat_"+Date.now();
chats[current]={title:"নতুন কথোপকথন",msgs:[]};
save();render();
}

function render(){
q("chatList").innerHTML="";
Object.keys(chats).reverse().forEach(id=>{
let d=document.createElement("div");
d.className="p-2 cursor-pointer "+(id===current?"bg-green-50":"");
d.innerText=chats[id].title;
d.onclick=()=>{current=id;render()}
q("chatList").appendChild(d);
});
box.innerHTML="";
chats[current].msgs.forEach(m=>draw(m.role,m.text,m.img));
q("chatTitle").innerText=chats[current].title;
box.scrollTop=box.scrollHeight;
}

function draw(role,text,img){
let w=document.createElement("div");
w.className="flex "+(role==="user"?"justify-end":"");
w.innerHTML=`
<div class="${role==="user"?"user":"ai"} max-w-2xl p-4">
${img?`<img src="data:image/jpeg;base64,${img}" class="mb-2 rounded">`:""}
<div class="content">${role==="user"?esc(text):"প্রসেস হচ্ছে..."}</div>
</div>`;
box.appendChild(w);
return w.querySelector(".content");
}

async function send(){
let t=input.value.trim();
if(!t&&!imgBase64)return;

let userMsg={role:"user",text:t,img:imgBase64};
chats[current].msgs.push(userMsg);
draw("user",t,imgBase64);

input.value="";clearImg();

let aiBox=draw("assistant","");
let full="",buf="";

const res=await fetch(API,{
method:"POST",
headers:{
"Content-Type":"application/json",
"X-Custom-Auth":AUTH
},
body:JSON.stringify({
prompt:t,
image:imgBase64,
history:chats[current].msgs.slice(-8)
})
});

const reader=res.body.getReader();
const dec=new TextDecoder();

while(true){
const {value,done}=await reader.read();
if(done)break;
buf+=dec.decode(value,{stream:true});
buf.split("\n\n").slice(0,-1).forEach(l=>{
if(l.startsWith("data:")){
let d=JSON.parse(l.slice(5));
if(d.type==="text"){
full+=d.content;
aiBox.innerHTML=marked.parse(full)+'<span class="cursor"></span>';
}
if(d.type==="status")chip(d.content);
}
});
}

aiBox.innerHTML=marked.parse(full);
chats[current].msgs.push({role:"assistant",text:full});
save();Prism.highlightAll();
}

function chip(t){
let d=document.createElement("div");
d.className="bg-green-100 px-2 py-1 rounded text-xs";
d.innerText=t;q("status").appendChild(d);
setTimeout(()=>d.remove(),4000);
}

function loadImg(e){
let f=e.target.files[0];if(!f)return;
let r=new FileReader();
r.onload=x=>{
imgBase64=x.target.result.split(",")[1];
q("imgPreview").src=x.target.result;
q("imgPreviewWrap").classList.remove("hidden");
}
r.readAsDataURL(f);
}

function clearImg(){imgBase64=null;q("imgPreviewWrap").classList.add("hidden")}

function save(){localStorage.setItem("bdChats",JSON.stringify(chats))}
function esc(t){return t.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))}

newChat();
marked.setOptions({breaks:true});
</script>
</body>
</html>
