<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD4land Master AI | Professional Hybrid</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&display=swap');
        
        :root { --bd-green: #006a4e; --bd-red: #f42a41; }
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f9fafb; overflow: hidden; }
        
        .chat-container { height: calc(100vh - 160px); scroll-behavior: smooth; }
        .sidebar { transition: all 0.3s ease; width: 280px; z-index: 50; background: #f3f4f6; }
        @media (max-width: 768px) { .sidebar { position: absolute; left: -280px; height: 100%; } .sidebar.active { left: 0; } }

        .ai-msg { border-radius: 2px 18px 18px 18px; border: 1px solid #e5e7eb; background: white; }
        .user-msg { border-radius: 18px 18px 2px 18px; background: var(--bd-green); color: white; }
        
        .conv-item.active { background: white; border-color: var(--bd-green); color: var(--bd-green); }
        .cursor { display: inline-block; width: 3px; height: 15px; background: var(--bd-green); margin-left: 2px; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex text-gray-900">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar border-r flex flex-col h-screen shadow-lg">
        <div class="p-4 border-b bg-white">
            <button onclick="createNewChat()" class="w-full bg-white border-2 border-dashed border-gray-300 rounded-xl py-2.5 text-sm font-bold text-gray-600 hover:border-green-600 hover:text-green-600 transition flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> নতুন চ্যাট শুরু করুন
            </button>
        </div>
        <div id="conv-list" class="flex-1 overflow-y-auto p-3 space-y-2">
            <!-- Conversations will load here -->
        </div>
        <div class="p-4 border-t bg-white">
            <div class="flex items-center gap-3 p-2 bg-green-50 rounded-xl border border-green-100">
                <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white text-[10px]"><i class="fas fa-flag"></i></div>
                <div class="text-[11px] font-bold text-green-800 uppercase">BD4land Master<br><span class="text-[9px] text-gray-400">Persistent V3.5</span></div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-14 border-b bg-white/95 flex items-center justify-between px-6 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500"><i class="fas fa-bars text-xl"></i></button>
                <h2 id="current-chat-title" class="font-bold text-gray-700 truncate max-w-[200px] md:max-w-md">নতুন কথোপকথন</h2>
            </div>
            <div class="flex gap-2">
                <span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">2025 ONLINE</span>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-box" class="chat-container overflow-y-auto p-4 md:px-24 lg:px-48 space-y-6">
            <!-- Messages load here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 md:px-24 lg:px-48 bg-white border-t">
            <div id="status-chips" class="flex gap-2 mb-2"></div>
            
            <div id="image-preview-container" class="hidden mb-3 p-2 bg-gray-50 rounded-xl border border-dashed border-gray-300 relative inline-block">
                <img id="image-preview" src="" class="h-20 rounded shadow-md">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px]"><i class="fas fa-times"></i></button>
            </div>

            <div class="relative flex items-end gap-2 bg-gray-100 rounded-2xl p-2 border border-gray-200 focus-within:bg-white focus-within:border-green-500 transition-all shadow-md">
                <label class="p-3 text-gray-400 hover:text-green-600 cursor-pointer">
                    <i class="fas fa-image text-xl"></i>
                    <input type="file" id="image-input" class="hidden" accept="image/*" onchange="processImage(event)">
                </label>
                <textarea id="input" rows="1" placeholder="যেকোনো কিছু জিজ্ঞাসা করুন..." class="w-full bg-transparent px-2 py-3 focus:outline-none resize-none max-h-40 text-gray-700"></textarea>
                <button onclick="send()" id="send-btn" class="bg-green-700 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-green-800 disabled:opacity-50 transition shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

<script>
    // --- IndexedDB Complex Logic ---
    const DB_NAME = "BD4land_Pro_DB";
    const DB_VERSION = 1;
    let db;
    let currentChatId = localStorage.getItem('currentChatId') || null;
    let chatHistory = [];
    let selectedImageBase64 = null;

    const dbRequest = indexedDB.open(DB_NAME, DB_VERSION);
    dbRequest.onupgradeneeded = (e) => {
        const d = e.target.result;
        d.createObjectStore("conversations", { keyPath: "id" });
        d.createObjectStore("messages", { keyPath: "msgId", autoIncrement: true }).createIndex("chatId", "chatId", { unique: false });
    };
    dbRequest.onsuccess = (e) => {
        db = e.target.result;
        initApp();
    };

    function initApp() {
        renderConversationList();
        if (currentChatId) {
            loadChat(currentChatId);
        } else {
            createNewChat();
        }
    }

    // --- Conversation Management ---
    async function createNewChat() {
        const id = "chat_" + Date.now();
        const newChat = { id, title: "নতুন কথোপকথন", time: Date.now() };
        const tx = db.transaction("conversations", "readwrite");
        await tx.objectStore("conversations").add(newChat);
        switchChat(id);
    }

    async function switchChat(id) {
        currentChatId = id;
        localStorage.setItem('currentChatId', id);
        document.getElementById('chat-box').innerHTML = "";
        chatHistory = [];
        loadChat(id);
        renderConversationList();
    }

    async function loadChat(id) {
        const tx = db.transaction(["conversations", "messages"], "readonly");
        const conv = await tx.objectStore("conversations").get(id);
        conv.onsuccess = (e) => {
            if (e.target.result) document.getElementById('current-chat-title').innerText = e.target.result.title;
        };

        const msgIndex = tx.objectStore("messages").index("chatId");
        const request = msgIndex.getAll(id);
        request.onsuccess = () => {
            const msgs = request.result;
            msgs.forEach(m => {
                const div = appendMessage(m.content, m.role, m.image);
                if (m.role === 'ai') div.querySelector('.content-area').innerHTML = marked.parse(m.content);
            });
            chatHistory = msgs.slice(-8).map(m => ({ role: m.role, content: m.content }));
            Prism.highlightAll();
            box.scrollTop = box.scrollHeight;
        };
    }

    async function renderConversationList() {
        const list = document.getElementById('conv-list');
        list.innerHTML = "";
        const tx = db.transaction("conversations", "readonly");
        const store = tx.objectStore("conversations");
        const request = store.getAll();
        request.onsuccess = () => {
            const convs = request.result.sort((a, b) => b.time - a.time);
            convs.forEach(c => {
                const div = document.createElement('div');
                div.className = `conv-item flex items-center justify-between p-3 text-sm rounded-xl cursor-pointer border border-transparent hover:bg-white group transition ${c.id === currentChatId ? 'active shadow-sm border-green-200' : 'text-gray-500'}`;
                div.onclick = () => switchChat(c.id);
                div.innerHTML = `
                    <div class="flex items-center gap-2 truncate">
                        <i class="far fa-comment-alt"></i>
                        <span class="truncate">${c.title}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 p-1"><i class="fas fa-trash-alt"></i></button>
                `;
                list.appendChild(div);
            });
        };
    }

    async function deleteChat(id) {
        if (!confirm("এই চ্যাটটি কি ডিলিট করতে চান?")) return;
        const tx = db.transaction(["conversations", "messages"], "readwrite");
        await tx.objectStore("conversations").delete(id);
        // Delete messages linked to this chatId (complex logic for simple IDB, here we just clear the list)
        if (currentChatId === id) {
            localStorage.removeItem('currentChatId');
            currentChatId = null;
            location.reload();
        } else {
            renderConversationList();
        }
    }

    // --- Message Handling ---
    async function send() {
        const prompt = input.value.trim();
        if (!prompt && !selectedImageBase64) return;

        const imgToSend = selectedImageBase64;
        appendMessage(prompt, 'user', imgToSend);
        
        // Save User Message
        const tx = db.transaction(["messages", "conversations"], "readwrite");
        tx.objectStore("messages").add({ chatId: currentChatId, role: 'user', content: prompt, image: imgToSend });
        
        // Update Title if it's the first message
        if (chatHistory.length === 0 && prompt) {
            const convStore = tx.objectStore("conversations");
            const req = convStore.get(currentChatId);
            req.onsuccess = () => {
                const data = req.result;
                data.title = prompt.substring(0, 30) + "...";
                convStore.put(data);
                renderConversationList();
            }
        }

        input.value = '';
        input.style.height = 'auto';
        sendBtn.disabled = true;
        clearImage();

        const aiWrapper = appendMessage("", 'ai');
        const contentArea = aiWrapper.querySelector('.content-area');
        let fullText = "";

        try {
            const response = await fetch('https://ai.obaydul2009-info.workers.dev', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, history: chatHistory, image: imgToSend })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.trim().startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.trim().substring(6));
                            if (data.type === 'text') {
                                fullText += data.content;
                                contentArea.innerHTML = marked.parse(fullText) + '<span class="cursor"></span>';
                            } else if (data.type === 'status') {
                                showStatus(data.content);
                            }
                        } catch (e) { }
                    }
                }
                box.scrollTop = box.scrollHeight;
            }
            
            contentArea.querySelector('.cursor')?.remove();
            Prism.highlightAllUnder(aiWrapper);
            
            // Save AI Message
            const tx2 = db.transaction("messages", "readwrite");
            tx2.objectStore("messages").add({ chatId: currentChatId, role: 'ai', content: fullText });
            chatHistory.push({ role: 'user', content: prompt }, { role: 'ai', content: fullText });

        } catch (e) {
            contentArea.innerHTML = "কানেকশন এরর। আবার চেষ্টা করুন।";
        } finally {
            sendBtn.disabled = false;
        }
    }

    // --- Helpers ---
    function processImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * (MAX_WIDTH / img.width);
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                document.getElementById('image-preview').src = canvas.toDataURL('image/jpeg');
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function clearImage() {
        selectedImageBase64 = null;
        document.getElementById('image-input').value = "";
        document.getElementById('image-preview-container').classList.add('hidden');
    }

    function appendMessage(content, role, imageData = null) {
        const div = document.createElement('div');
        div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : ''}`;
        let imgTag = imageData ? `<img src="data:image/jpeg;base64,${imageData}" class="max-h-60 rounded-xl mb-2 shadow-md border-2 border-white">` : '';
        div.innerHTML = `
            ${role === 'ai' ? '<div class="w-8 h-8 rounded-full bg-green-700 flex items-center justify-center text-white flex-shrink-0 font-bold shadow-md">B</div>' : ''}
            <div class="${role === 'user' ? 'user-msg' : 'ai-msg'} p-4 max-w-[85%] md:max-w-2xl overflow-hidden shadow-sm">
                ${imgTag}
                <div class="content-area prose prose-sm max-w-none">
                    ${role === 'user' ? escapeHtml(content) : (content ? marked.parse(content) : '<span class="animate-pulse">প্রসেস হচ্ছে...</span>')}
                </div>
            </div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div;
    }

    function showStatus(text) {
        const chip = document.createElement('div');
        chip.className = "bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-200 animate-pulse mb-2";
        chip.innerHTML = text;
        statusChips.appendChild(chip);
        setTimeout(() => chip.remove(), 4000);
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    function copyCode(id) {
        navigator.clipboard.writeText(document.getElementById(id).innerText);
        alert("কপি হয়েছে!");
    }

    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: function(code, lang) {
            return Prism.highlight(code, Prism.languages[lang] || Prism.languages.markup, lang);
        },
        breaks: true
    });
</script>
</body>
</html>
