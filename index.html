<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BD4LAND Master AI | 2025</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Prism -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&display=swap');
:root{--bd:#006a4e}
body{font-family:'Hind Siliguri',sans-serif;background:#f9fafb}
.ai{background:#fff;border:1px solid #e5e7eb;border-radius:6px 18px 18px 18px}
.user{background:var(--bd);color:#fff;border-radius:18px 18px 6px 18px}
.cursor{display:inline-block;width:3px;height:16px;background:var(--bd);animation:blink 1s infinite}
@keyframes blink{50%{opacity:0}}
</style>
</head>

<body class="flex h-screen text-gray-900">

<!-- SIDEBAR -->
<aside class="w-72 bg-white border-r flex flex-col">
  <div class="p-4 border-b">
    <button onclick="newChat()" class="w-full border rounded-xl py-2 font-bold">
      <i class="fa fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü
    </button>
  </div>
  <div id="chatList" class="flex-1 overflow-y-auto p-2"></div>
  <div class="p-3 text-xs font-bold text-green-700">BD4LAND AI ‚Ä¢ 2025</div>
</aside>

<!-- MAIN -->
<main class="flex-1 flex flex-col">

<header class="h-14 border-b bg-white flex items-center justify-between px-4">
  <h2 id="chatTitle" class="font-bold truncate">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®</h2>
  <span class="text-xs bg-green-100 px-2 py-1 rounded">LIVE</span>
</header>

<div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

<!-- INPUT -->
<div class="border-t bg-white p-3">
  <div id="status" class="flex gap-2 mb-2"></div>

  <div id="imgPreviewWrap" class="hidden mb-2 relative inline-block">
    <img id="imgPreview" class="h-16 rounded">
    <button onclick="clearImg()" class="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-xs">√ó</button>
  </div>

  <div class="flex gap-2 bg-gray-100 rounded-2xl p-2 items-end">
    <label class="cursor-pointer p-2">
      <i class="fa fa-camera"></i>
      <input hidden type="file" accept="image/*" onchange="loadImg(event)">
    </label>

    <button onclick="removeBG()" class="p-2" title="Remove Background">
      <i class="fa fa-magic"></i>
    </button>

    <textarea id="input" rows="1"
      class="flex-1 bg-transparent resize-none outline-none"
      placeholder="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®..."></textarea>

    <button onclick="send()" class="bg-green-700 text-white w-11 h-11 rounded-xl">
      <i class="fa fa-paper-plane"></i>
    </button>
  </div>
</div>

</main>

<script>
const API="https://ai.obaydul2009-info.workers.dev";
const AUTH="my_secure_handshake_key";

let chats=JSON.parse(localStorage.getItem("bdChats")||"{}");
let current=null;
let imgBase64=null;

const box=q("chatBox"),input=q("input");

function q(id){return document.getElementById(id)}

function newChat(){
  current="chat_"+Date.now();
  chats[current]={title:"‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶®",msgs:[]};
  save();render();
}

function render(){
  q("chatList").innerHTML="";
  Object.keys(chats).reverse().forEach(id=>{
    const d=document.createElement("div");
    d.className="p-2 flex justify-between items-center hover:bg-green-50";

    const t=document.createElement("span");
    t.className="cursor-pointer truncate";
    t.innerText=chats[id].title;
    t.onclick=()=>{current=id;render()};

    const del=document.createElement("button");
    del.innerHTML="üóëÔ∏è";
    del.onclick=()=>{
      if(confirm("‡¶è‡¶á ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")){
        delete chats[id];
        if(current===id) newChat();
        save(); render();
      }
    };

    d.append(t,del);
    q("chatList").appendChild(d);
  });

  box.innerHTML="";
  chats[current]?.msgs.forEach(m=>draw(m.role,m.text,m.img));
  q("chatTitle").innerText=chats[current]?.title||"";
  box.scrollTop=box.scrollHeight;
}

function draw(role,text,img){
  const w=document.createElement("div");
  w.className="flex "+(role==="user"?"justify-end":"");
  w.innerHTML=`
  <div class="${role==="user"?"user":"ai"} max-w-2xl p-4">
    ${img?`<img src="data:image/jpeg;base64,${img}" class="mb-2 rounded">`:""}
    <div class="content">${role==="user"?esc(text):"‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."}</div>
  </div>`;
  box.appendChild(w);
  return w.querySelector(".content");
}

async function send(){
  const t=input.value.trim();
  if(!t && !imgBase64) return;

  chats[current].msgs.push({role:"user",text:t,img:imgBase64});
  draw("user",t,imgBase64);

  input.value=""; clearImg();

  const aiBox=draw("assistant","");
  let full="",buf="";

  const res=await fetch(API,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Custom-Auth":AUTH
    },
    body:JSON.stringify({
      prompt:t,
      image:imgBase64,
      history:chats[current].msgs.slice(-8)
    })
  });

  const reader=res.body.getReader();
  const dec=new TextDecoder();

  while(true){
    const {value,done}=await reader.read();
    if(done)break;
    buf+=dec.decode(value,{stream:true});
    buf.split("\n\n").slice(0,-1).forEach(l=>{
      if(l.startsWith("data:")){
        const d=JSON.parse(l.slice(5));
        if(d.type==="text"){
          full+=d.content;
          aiBox.innerHTML=marked.parse(full)+'<span class="cursor"></span>';
        }
        if(d.type==="status") chip(d.content);
      }
    });
  }

  aiBox.innerHTML=marked.parse(full);
  chats[current].msgs.push({role:"assistant",text:full});
  save(); Prism.highlightAll();
}

function chip(t){
  const d=document.createElement("div");
  d.className="bg-green-100 px-2 py-1 rounded text-xs";
  d.innerText=t;
  q("status").appendChild(d);
  setTimeout(()=>d.remove(),4000);
}

function loadImg(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=x=>{
    imgBase64=x.target.result.split(",")[1];
    q("imgPreview").src=x.target.result;
    q("imgPreviewWrap").classList.remove("hidden");
  }
  r.readAsDataURL(f);
}

function removeBG(){
  if(!imgBase64) return alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®");
  const img=new Image();
  img.src="data:image/jpeg;base64,"+imgBase64;
  img.onload=()=>{
    const c=document.createElement("canvas");
    c.width=img.width; c.height=img.height;
    const ctx=c.getContext("2d");
    ctx.drawImage(img,0,0);
    const d=ctx.getImageData(0,0,c.width,c.height);
    for(let i=0;i<d.data.length;i+=4){
      if(d.data[i]>240 && d.data[i+1]>240 && d.data[i+2]>240){
        d.data[i+3]=0;
      }
    }
    ctx.putImageData(d,0,0);
    imgBase64=c.toDataURL("image/png").split(",")[1];
    q("imgPreview").src=c.toDataURL("image/png");
  }
}

function clearImg(){
  imgBase64=null;
  q("imgPreviewWrap").classList.add("hidden");
}

function save(){
  localStorage.setItem("bdChats",JSON.stringify(chats));
}

function esc(t){
  return t.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

marked.setOptions({breaks:true});
newChat();
</script>
</body>
</html>
