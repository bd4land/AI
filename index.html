<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD4land Master AI | 2025 Hybrid</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&display=swap');
        
        :root {
            --bd-green: #006a4e;
            --bd-red: #f42a41;
        }

        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .chat-container { height: calc(100vh - 180px); scroll-behavior: smooth; }
        
        .sidebar { transition: all 0.3s ease; width: 280px; z-index: 50; background: #ffffff; }
        @media (max-width: 768px) { .sidebar { position: absolute; left: -280px; height: 100%; } .sidebar.active { left: 0; } }

        .ai-msg { border-radius: 2px 18px 18px 18px; border: 1px solid #e2e8f0; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .user-msg { border-radius: 18px 18px 2px 18px; background: var(--bd-green); color: white; box-shadow: 0 4px 10px rgba(0, 106, 78, 0.2); }

        .cursor { display: inline-block; width: 3px; height: 15px; background: var(--bd-green); margin-left: 2px; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        /* BD Style Accents */
        .bd-border { border-top: 4px solid var(--bd-red); }
        .scrollbar-bd::-webkit-scrollbar { width: 5px; }
        .scrollbar-bd::-webkit-scrollbar-thumb { background: var(--bd-green); border-radius: 10px; }
    </style>
</head>
<body class="flex text-gray-900">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar border-r flex flex-col h-screen shadow-2xl">
        <div class="p-4 bd-border bg-gray-50">
            <button onclick="resetChat()" class="w-full bg-white border border-red-200 rounded-xl py-2.5 text-sm font-bold text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center gap-2 shadow-sm">
                <i class="fas fa-rotate-right"></i> নতুন চ্যাট শুরু করুন
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto scrollbar-bd">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-widest">আজকের কথোপকথন</h3>
            <div id="history-list" class="space-y-2">
                <!-- History Items -->
            </div>
        </div>
        <div class="p-4 border-t bg-gray-50">
            <div class="flex items-center gap-3 bg-green-50 p-2 rounded-lg border border-green-100">
                <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white shadow-md"><i class="fas fa-star text-[10px]"></i></div>
                <div class="text-[11px] font-bold text-green-800">MASTER AI V3.5<br><span class="text-[9px] text-gray-500">2025 SECURE ENGINE</span></div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen relative">
        <header class="h-16 border-b bg-white/95 backdrop-blur flex items-center justify-between px-6 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500"><i class="fas fa-bars text-xl"></i></button>
                <div class="flex flex-col">
                    <h1 class="font-bold text-green-800 text-lg flex items-center gap-2">
                        <i class="fas fa-circle-nodes text-red-600"></i> BD4land Master AI
                    </h1>
                    <div class="flex gap-2 text-[9px] font-bold text-gray-400 uppercase">
                        <span><i class="fas fa-bolt text-yellow-500"></i> 70B Engine</span>
                        <span><i class="fas fa-eye text-blue-500"></i> Vision Active</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-box" class="chat-container overflow-y-auto p-4 md:px-24 lg:px-48 space-y-6 scrollbar-bd">
            <!-- Messages load from IndexedDB -->
        </div>

        <!-- Input Area -->
        <div class="p-4 md:px-24 lg:px-48 bg-white border-t">
            <div id="status-chips" class="flex gap-2 mb-2"></div>
            
            <div id="image-preview-container" class="hidden mb-3 p-2 bg-gray-100 rounded-xl border-2 border-dashed border-green-300 relative inline-block">
                <img id="image-preview" src="" class="h-20 rounded-lg shadow-md">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-green-600 to-red-500 rounded-2xl blur opacity-10 group-focus-within:opacity-25 transition"></div>
                <div class="relative flex items-end gap-2 bg-white rounded-2xl p-2 border border-gray-200 shadow-lg">
                    <label class="p-3 text-gray-400 hover:text-green-600 cursor-pointer transition">
                        <i class="fas fa-camera-retro text-xl"></i>
                        <input type="file" id="image-input" class="hidden" accept="image/*" onchange="processImage(event)">
                    </label>
                    <textarea id="input" rows="1" placeholder="যেকোনো কিছু জিজ্ঞাসা করুন..." 
                        class="w-full bg-transparent px-2 py-3 focus:outline-none resize-none max-h-40 text-gray-700 font-medium"></textarea>
                    
                    <button onclick="send()" id="send-btn" 
                        class="bg-green-700 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-green-800 transition-all disabled:opacity-50">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- IndexedDB Logic ---
    const DB_NAME = "BD4landAI_V3";
    const STORE_NAME = "chat_history";
    let db;

    const dbRequest = indexedDB.open(DB_NAME, 1);
    dbRequest.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
    };
    dbRequest.onsuccess = (e) => {
        db = e.target.result;
        renderHistoryFromDB();
    };

    let chatHistory = [];
    let selectedImageBase64 = null;
    const box = document.getElementById('chat-box');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const statusChips = document.getElementById('status-chips');

    const renderer = new marked.Renderer();
    renderer.code = (token) => {
        const id = 'code-' + Math.random().toString(36).substr(2, 5);
        return `<div class="my-4 rounded-lg overflow-hidden border border-gray-700 shadow-xl">
            <div class="bg-gray-800 px-4 py-2 text-[10px] text-gray-400 flex justify-between font-mono">
                <span>${token.lang || 'code'}</span>
                <button onclick="copyCode('${id}')" class="hover:text-white"><i class="far fa-copy"></i> Copy</button>
            </div>
            <pre id="${id}" class="language-${token.lang}"><code class="language-${token.lang}">${token.text}</code></pre>
        </div>`;
    };
    marked.setOptions({ renderer, breaks: true });

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    // --- Image Compression (Fixes Processing Hang) ---
    function processImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; // ছবি রিসাইজ
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                document.getElementById('image-preview').src = canvas.toDataURL('image/jpeg');
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function clearImage() {
        selectedImageBase64 = null;
        document.getElementById('image-input').value = "";
        document.getElementById('image-preview-container').classList.add('hidden');
    }

    async function saveMessage(role, content, image = null) {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).add({ role, content, image, time: Date.now() });
    }

    function renderHistoryFromDB() {
        const tx = db.transaction(STORE_NAME, "readonly");
        const request = tx.objectStore(STORE_NAME).getAll();
        request.onsuccess = () => {
            const msgs = request.result;
            if (msgs.length === 0) {
                appendMessage("আসসালামু আলাইকুম! আমি **BD4land Master AI**। আজ আপনাকে কীভাবে সাহায্য করতে পারি?", 'ai');
            } else {
                msgs.forEach(m => {
                    const div = appendMessage(m.content, m.role, m.image);
                    if (m.role === 'ai') div.querySelector('.content-area').innerHTML = marked.parse(m.content);
                });
                chatHistory = msgs.slice(-10).map(m => ({ role: m.role, content: m.content }));
                Prism.highlightAll();
                updateSidebarUI(msgs[0]?.content);
            }
        };
    }

    async function send() {
        const prompt = input.value.trim();
        if (!prompt && !selectedImageBase64) return;

        const imgToSend = selectedImageBase64;
        appendMessage(prompt, 'user', imgToSend);
        saveMessage('user', prompt, imgToSend);

        input.value = '';
        input.style.height = 'auto';
        sendBtn.disabled = true;
        clearImage();

        const aiWrapper = appendMessage("", 'ai');
        const contentArea = aiWrapper.querySelector('.content-area');
        let fullText = "";

        try {
            const response = await fetch('https://ai.obaydul2009-info.workers.dev', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, history: chatHistory, image: imgToSend })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        if (data.type === 'text') {
                            fullText += data.content;
                            contentArea.innerHTML = marked.parse(fullText) + '<span class="cursor"></span>';
                            if (fullText.length % 30 === 0) Prism.highlightAllUnder(aiWrapper);
                        } else if (data.type === 'status') {
                            showStatus(data.content);
                        } else if (data.type === 'image') {
                            contentArea.innerHTML = `<img src="${data.content}" class="rounded-xl shadow-lg border-4 border-white mt-2">`;
                        }
                    }
                }
                box.scrollTop = box.scrollHeight;
            }
            
            contentArea.querySelector('.cursor')?.remove();
            Prism.highlightAllUnder(aiWrapper);
            saveMessage('ai', fullText);
            chatHistory.push({ role: 'user', content: prompt }, { role: 'ai', content: fullText });

        } catch (e) {
            contentArea.innerHTML = "দুঃখিত, কানেকশনে সমস্যা হয়েছে।";
        } finally {
            sendBtn.disabled = false;
        }
    }

    function appendMessage(content, role, imageData = null) {
        const div = document.createElement('div');
        div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : ''}`;
        
        let imgTag = imageData ? `<img src="data:image/jpeg;base64,${imageData}" class="max-h-60 rounded-xl mb-2 shadow-md border-2 border-white">` : '';
        
        div.innerHTML = `
            ${role === 'ai' ? '<div class="w-9 h-9 rounded-full bg-green-700 flex items-center justify-center text-white flex-shrink-0 font-bold shadow-md">B</div>' : ''}
            <div class="${role === 'user' ? 'user-msg' : 'ai-msg'} p-4 max-w-[85%] md:max-w-2xl overflow-hidden shadow-sm">
                ${imgTag}
                <div class="content-area prose prose-sm max-w-none">
                    ${role === 'user' ? content : (content ? marked.parse(content) : '<span class="animate-pulse">প্রসেস হচ্ছে...</span>')}
                </div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div;
    }

    function showStatus(text) {
        const chip = document.createElement('div');
        chip.className = "bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-200 animate-pulse mb-2";
        chip.innerHTML = `<i class="fas fa-search mr-1"></i> ${text}`;
        statusChips.appendChild(chip);
        setTimeout(() => chip.remove(), 4000);
    }

    function updateSidebarUI(text) {
        const list = document.getElementById('history-list');
        list.innerHTML = `<div class="p-3 text-xs bg-green-50 text-green-800 rounded-lg border border-green-100 truncate font-bold">
            <i class="fas fa-message mr-2"></i> ${text || "নতুন কথোপকথন"}
        </div>`;
    }

    async function resetChat() {
        if(confirm("সব চ্যাট কি মুছে ফেলবেন?")) {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).clear();
            location.reload();
        }
    }

    function copyCode(id) {
        navigator.clipboard.writeText(document.getElementById(id).innerText);
        alert("কপি হয়েছে!");
    }

    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });
</script>
</body>
</html>
